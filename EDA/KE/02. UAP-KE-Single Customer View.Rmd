---
title: "Creating Single Customer View"
author: "John Mwangi"
date: "`r Sys.Date()`"
output: html_document:
  toc:yes
  toc_float:true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```


# DATA CONSOLIDATION

## Useful fields

```{r}
health_claims_names <- 
  c("ADMISSIBLE_AMOUNT",
    "CLAIM_TYPE",
    "CLAUSE_CODE",
    "INADMISSIBLE_AMOUNT",
    "MEMBER_NO")

Health_Policy_Details_names <- 
c("ACCOUNT_NO",
  "AMOUNT_COVERED",
  "COVER_TYPE")

Health_Policy_Header_names <- 
c("ACCOUNT_NO",
  "BUSINESS_TYPE",
  "INTERMEDIARY_CODE",
  "MEMBER_NO",
  "PAYMENT_FREQUENCY",
  "POLICY",
  "POLICY_TERM",
  "POLICY_TYPE",
  "START_DATE",
  "STATUS")

Health_intermediary_names <- c("INTERMEDIARY_CODE")

intermediary_master_names <- c("INTERMEDIARY_CODE")
```

## Check intersecting columns

```{r}
intersect(colnames(Health_Policy_Details),colnames(health_claims))
```

Health Claims cannot be joined to Health_Policy_Header table

```{r}
Health_Policy_Header %>% 
  select(MEMBER_NO) %>%
  inner_join(health_claims %>% 
               select(MEMBER_NO))
```

Health Claims cannot be joined to Health_Policy_Details table

```{r}
class(Health_Policy_Details$POLICY_NO)
```

```{r}
intersect(colnames(Health_Policy_Header), colnames(Health_intermediary))
```

```{r}
Health_Policy_Header$INTERMEDIARY_CODE[1:20]
Health_intermediary$INTERMEDIARY_CODE[1:20]
```

```{r}
Health_Policy_Header %>% 
  select(INTERMEDIARY_CODE) %>% 
  mutate_all(as.character) %>% 
  inner_join(Health_intermediary %>% 
               select(INTERMEDIARY_CODE))
```


## Creating a single view of the customer

A number of tables could not be joined or was not necessary to join.

```{r}
KE_Single_View <- Health_Policy_Header %>%
  select(Health_Policy_Header_names) %>% 
  left_join(Health_Policy_Details %>% select(Health_Policy_Details_names),
            by = "ACCOUNT_NO")

KE_Single_View <- KE_Single_View %>%
  left_join(policy_term, 
            by = c("POLICY_TERM"="TERM_ID"))
```


# DATA AGGREGATION AND CONSOLIDATION

## Data preview

```{r}
KE_Single_View <- read_rds("./KE_Single_View.rds")
```

Assumption is that ACCOUNT_NO represents the customer ID. Objective is to map one Customer ID (ACCOUNT_NO) to one/many product ID (COVER_TYPE).

All columns are constant except the AMOUNT_COVERED column. It is this column that will require aggregation. (Each row is a different member within a customer).

```{r}
KE_Single_View %>% 
  sample_n(200)
```
## Identify field to aggregate

The Amount Covered can be aggregated as an average with additional information of the number of people covered.

`START_DATE` is excluded because employees could be put within the same type of cover regardless of their date of joining the organisation.

```{r}
cols_to_aggr <- which(grepl(pattern = "AMOUNT_COVERED|MEMBER_NO|START_DATE", 
                                  ignore.case = TRUE, 
                                  x = colnames(KE_Single_View)))

grouping_vars <- paste0(colnames(KE_Single_View)[-cols_to_aggr],collapse = ",")

#grouping_vars <- colnames(KE_Single_View)[-cols_to_aggr]

grouping_vars
```

```{r}
set.seed(123)
KE_Single_View %>% 
  sample_n(200) %>% 
  group_by(ACCOUNT_NO,BUSINESS_TYPE,INTERMEDIARY_CODE,PAYMENT_FREQUENCY,POLICY,POLICY_TERM,POLICY_TYPE,STATUS,COVER_TYPE,TERM_NAME) %>% 
  summarise(AVG_AMOUNT_COVERED = mean(AMOUNT_COVERED),
            MEMBERS = n()) %>% 
  ungroup() %>% 
  arrange(ACCOUNT_NO) %>% 
  select(ACCOUNT_NO) %>% 
  count(ACCOUNT_NO) %>% 
  filter(n>1)
```

## Testing aggregation

```{r}
set.seed(123)
KE_Single_View %>% 
  sample_n(200) %>% 
  group_by(ACCOUNT_NO,BUSINESS_TYPE,INTERMEDIARY_CODE,PAYMENT_FREQUENCY,POLICY,POLICY_TERM,POLICY_TYPE,STATUS,COVER_TYPE,TERM_NAME) %>% 
  summarise(AVG_AMOUNT_COVERED = mean(AMOUNT_COVERED),
            MEMBERS = n()) %>% 
  ungroup() %>% 
  arrange(ACCOUNT_NO) %>% 
  filter(ACCOUNT_NO==848400)
```

## Aggregated Customer Single View

```{r}
KE_Single_View_Consolidated <- 
KE_Single_View %>%
  group_by(ACCOUNT_NO,BUSINESS_TYPE,INTERMEDIARY_CODE,PAYMENT_FREQUENCY,POLICY,POLICY_TERM,POLICY_TYPE,STATUS,COVER_TYPE,TERM_NAME) %>% 
  summarise(AVG_AMOUNT_COVERED = mean(AMOUNT_COVERED),
            MEMBERS = n()) %>% 
  ungroup() %>% 
  arrange(ACCOUNT_NO)
```
# CORRECTING DATA TYPES

## Current data types

```{r}
KE_Single_View_Consolidated %>% 
  summarise_all(class) %>% 
  pivot_longer(cols = everything())
```

## Corrected data types


ACCOUNT_NO,INTERMEDIARY_CODE,POLICY_TERM

```{r}
KE_Single_View_Consolidated <-
KE_Single_View_Consolidated %>% 
  mutate_at(.vars = vars(ACCOUNT_NO,INTERMEDIARY_CODE,POLICY_TERM), .funs = as.character)

head(KE_Single_View_Consolidated)
```



# SAVE PROJECT DATA

```{r}
save.image("./UAP_KE_EDA.RData")
```

```{r}
saveRDS(object = KE_Single_View, file = "./KE_Single_View.rds")
```

```{r}
saveRDS(object = KE_Single_View_Consolidated, file = "./KE_Single_View_Consolidated.rds")
```


