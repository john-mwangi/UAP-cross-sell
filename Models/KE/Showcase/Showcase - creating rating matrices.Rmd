---
title: "UAP Showcase"
output: html_document
---


```{r}
ke_single_view_consolidated <- readRDS("../../analysis/KE/KE_Single_View_Consolidated.rds")
```


```{r}
library(recommenderlab)
library(tidyverse)
library(fastDummies)
```

Usage: Recommender(MovieLense, method="UBCF")

```{r}
data("MovieLense")

class(MovieLense)
```

# TYPES OF VALID DATA

Types of training data that are required:
* binaryRatingMatrix - where purchase decisions are binary: you either purchase or you don't (MSWeb)
* realRatingMatrix - where a customer provides product ratings e.g. 1-5 stars (MovieLens)
* ratingMatrix - common class for rating data. No dataset present but thinking that the other two are preferred.

# CONVERT TO BINARY RATING MATRIX

Covert data to `binaryRatingMatrix`

Ref: https://www.rdocumentation.org/packages/recommenderlab/versions/0.2-7/topics/binaryRatingMatrix

row = user_id, columns = is_item_id_bought


matrix(sample(c(0,1), 50, replace=TRUE), nrow=5, ncol=10,
dimnames=list(users=paste("u", 1:5, sep=''),
items=paste("i", 1:10, sep='')))


## Create Matrix

```{r}
ke_matrix <- 
  ke_single_view_consolidated %>% 
  select(ACCOUNT_NO, COVER_TYPE) %>%
  filter(!is.na(COVER_TYPE)) %>% 
  dummy_cols(select_columns = "COVER_TYPE", remove_selected_columns = TRUE) %>% 
  distinct(ACCOUNT_NO, .keep_all = TRUE) %>% 
  select(-ACCOUNT_NO) %>% 
  as.matrix()
```


```{r}
rownames(ke_matrix) <-
ke_single_view_consolidated %>% 
  filter(!is.na(COVER_TYPE)) %>% 
  distinct(ACCOUNT_NO) %>% 
  pull(ACCOUNT_NO)
```

```{r}
rownames(ke_matrix)[1:10]
colnames(ke_matrix)
```
## Create binaryRatingMatrix

```{r}
ke_bin_mat <- as(ke_matrix, "binaryRatingMatrix")
```


# DUMMY UAP DATA

## Data importantion

```{r}
uap_products_raw <- read_csv("../../input/product_names/UAP-OM Insurance Products - Sheet1.csv") %>% 
  janitor::clean_names()
```

```{r}
uap_products <- uap_products_raw %>% 
  pivot_longer(cols = starts_with("product"),
               values_to = "product") %>% 
  filter(!is.na(product)) %>% 
  select(product, business_line)

head(uap_products)
```


```{r}
uap_products %>% 
  count(business_line, name = "products") %>% 
  mutate(all_products = sum(products))


uap_products %>% 
  count(product)
```

## Generate raw data

Take top 55 of the MSWeb10 data

```{r}
load("./Showcase - dummy - Copy.RData")
```


```{r}
colnames(MSWeb10)[1:10]
```

```{r}
msweb_topn <- as(MSWeb10,"data.frame") %>% 
  count(item) %>% 
  arrange(desc(n)) %>% 
  head(55) %>% 
  pull(item)
```

Create matching dataframe

```{r}
msweb_uap_match <-
data.frame(msweb = msweb_topn,
           uap = uap_products$product)
```

Match MSWeb to UAP dummy data

```{r}
uap_dummy_data_proc <-
as(MSWeb10,"data.frame") %>% 
  filter(item %in% msweb_topn) %>% 
  left_join(msweb_uap_match, by = c("item"="msweb")) %>% 
  left_join(uap_products, by = c("uap"="product")) %>%
  select(user=user, item=uap, rating=rating)
```

Convert to ratingMatrix

```{r}
uap_dummy_rating_matrix <- as(uap_dummy_data_proc,"binaryRatingMatrix")
```

# SAVE DATA

```{r}
saveRDS(object = uap_dummy_rating_matrix, file = "./uap_dummy_data_rating_matrix.rds")


saveRDS(object = uap_products, file = "./uap_products.rds")
```

