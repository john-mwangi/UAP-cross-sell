---
title: "Product values"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(glue)
library(readxl)
library(lubridate)
library(tidyverse)
```


# GENERAL INSURANCE

## Statements

```{r}
general_statements_raw <-
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/NG/general/GI_Policy_Statements.csv") %>% 
  mutate(TRANSACTION_DATE = dmy(TRANSACTION_DATE))
```

"Create Policy" is when a policy is bought.

```{r}
general_statements_raw %>% 
  filter(AMOUNT > 0) %>% 
  count(TRANSACTION_TYPE)
```

## Products

Product names with policy number.

```{r}
general_products <-
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/NG/general/Policy_Header_Non_Life_GI.csv") %>% 
  select(POLICY_NO, BUSINESS_TYPE)
```

```{r}
length(intersect(general_products$POLICY_NO, general_statements_raw$POLICY_NO))
```
## Product values

```{r}
general_product_values <-
general_statements_raw %>% 
  filter(AMOUNT > 0) %>% 
  filter(TRANSACTION_TYPE == "Create Policy") %>% 
  filter(TRANSACTION_DATE >= "2018-01-01") %>% 
  left_join(general_products, by = "POLICY_NO") %>% 
  select(BUSINESS_TYPE, AMOUNT) %>% 
  group_by(BUSINESS_TYPE) %>% 
  summarise(product_value = round(mean(AMOUNT)),
            accounts = n()) %>% 
  rename(PRODUCT = BUSINESS_TYPE)

general_product_values
```


# LIFE INSURANCE

## Statements

```{r}
gibbs_stmts_raw <-
read_excel(path = "../../../../../../C - Documentation/Data/festus_extraction/NG/life/statements/Life_Policy_Statements.csv_gibbs_life.xlsx") %>% 
  select(DATE, CONTRACT_ID, PAYMENT_PAID)

# Compen is blank
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/NG/life/statements/Life_Policy_Statements_20210504_compen_life.csv")

oipa_stmts_raw <-
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/NG/life/statements/LifePolicyStatements_20210301_195929_oipa_life.csv") %>% 
  select(DATE, CONTRACT_ID, PAYMENT_PAID)
```

Date filter was removed because it was result in very few products being retained.

```{r}
life_statements <- 
  rbind(gibbs_stmts_raw,
        oipa_stmts_raw) %>%
  filter(PAYMENT_PAID > 0)
  #filter(DATE >= "2018-01-01")

life_statements
```

## Products

Product names with policy number.

```{r}
life_products <- readRDS("../../02. Determine product holding/outputs/life_products.rds")

life_products
```

## Product values

```{r}
life_product_values <-
life_statements %>% 
  left_join(life_products, by = "CONTRACT_ID") %>% 
  select(CONTRACT_GROUP_NAME, PAYMENT_PAID) %>% 
  group_by(CONTRACT_GROUP_NAME) %>% 
  summarise(product_value = mean(PAYMENT_PAID),
            accounts = n()) %>% 
  filter(!is.na(CONTRACT_GROUP_NAME)) %>% 
  rename(PRODUCT = CONTRACT_GROUP_NAME)

life_product_values
```


# ALL PRODUCTS

```{r}
product_values <-
rbind(life_product_values,
      general_product_values)

product_values
```


# MISSING

Check that all products have assigned product values and impute.

```{r}
product_businesslines <-
readRDS(file = "../../04. Extract additional customer details/outputs/product_businesslines.rds")

product_businesslines
```


```{r}
product_businesslines %>% 
  left_join(product_values) %>% 
  filter(is.na(product_value))
```


```{r}
product_values <-
product_businesslines %>% 
  left_join(product_values, by = "PRODUCT") %>% 
  group_by(BUSINESS_LINE) %>%
  mutate(product_value = replace_na(product_value, 
                                    mean(product_value, na.rm = TRUE))) %>% 
  ungroup() %>%
  mutate(product_value = if_else(condition = is.nan(product_value), 
                                 true = 99999, 
                                 false = product_value)) %>% 
  mutate(product_value = round(product_value)) %>% 
  select(-BUSINESS_LINE)

product_values 
```

# EXPORT

```{r}
save.image("../outputs/03June_Product_Values.RData")
#load("../outputs/16May_Product_Values.RData")

saveRDS(product_values,"../outputs/product_values.rds")
```

