---
title: "Product-Customer Matching"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PACKAGES

```{r message=FALSE, warning=FALSE}
library(readxl)
library(data.table)
library(tidyverse)
```

# HEALTH PRODUCTS

Pick product details: product names & customer account number.

```{r}
health_products_raw <- 
  fread(file = "../../../../C - Documentation/Data/festus_extraction/kenya/health/policyheader_nonlife_kenya_product_names-HEALTH.csv")
```


```{r}
head(health_products_raw)
```

## Product Holding

The table below returns a table showing products held by each account (1 product, 1 account). n should be 1 in all cases.

```{r}
health_prod_holding <-
health_products_raw %>% 
  distinct(ACCOUNT_NO, Product) %>% 
  count(ACCOUNT_NO,Product) %>% 
  arrange(desc(n))

dim(health_prod_holding)
```


```{r}
health_prod_holding %>% 
  count(ACCOUNT_NO) %>% 
  arrange(desc(n))
```
One customer account number can hold more than one product.

```{r}
health_prod_holding %>% 
  filter(ACCOUNT_NO=="420754")
```


## Fixing Product Names

Keldine's email on 30 March 2021:
Basically, you have different afya products:- imara, county, exec etc; in addition, anything that is not retail should be corporate; anything that is retail and not defined should be Afya Imara.

```{r}
health_products_amended <-
health_products_raw %>%
  select(ACCOUNT_NO, Product, POLICY_TYPE) %>% 
  filter(POLICY_TYPE=="RETAIL") %>% 
  filter(str_detect(string = Product, 
                    pattern = "^AFYA.*", 
                    negate = TRUE)) %>% 
  mutate(Product_corrected = "AFYA IMARA") %>% 
  distinct(ACCOUNT_NO, Product = Product_corrected)

head(health_products_amended)
```

Check if it worked

```{r}
health_products_amended %>% 
  count(Product)
```

## Merged Products [FINAL]

Because one customer account number can contain more than one product, we join on the basis of `ACCOUNT_NO` and `Product`.

```{r}
health_product_holding_final <- health_prod_holding %>% 
# Exclude rows that were not amended
# Expect to see Corporate products and Retail products starting with Afya
  anti_join(health_products_raw %>%
            select(ACCOUNT_NO, Product, POLICY_TYPE) %>% 
            filter(POLICY_TYPE=="RETAIL") %>% 
            filter(str_detect(string = Product, 
                              pattern = "^AFYA.*", 
                              negate = TRUE)), 
            by = c("ACCOUNT_NO", "Product")) %>% 
# Include amended rows
  bind_rows(health_products_amended)

dim(health_product_holding_final)
dim(health_prod_holding)
```

Check if successful.

```{r}
health_product_holding_final %>% 
  count(ACCOUNT_NO, Product) %>% 
  arrange(desc(n))
```

## Number of products

```{r}
health_product_holding_final %>% 
  summarise(n_distinct(Product))
```

```{r}
health_product_holding_final %>% 
  count(Product) %>% 
  arrange(desc(n))
```

```{r}
health_product_holding_final <- health_product_holding_final %>% 
  mutate(n = replace_na(1))
```

```{r}
health_product_holding_final
```


# HEALTH CUSTOMERS

Blank Account Numbers are omitted since they do not contain any data.

```{r}
health_customers_raw <-
fread("../../../../C - Documentation/Data/festus_extraction/kenya/health/health_customer_kenya.csv") %>% 
  filter(ACCOUNT_NO != "")
```


```{r}
dim(health_customers_raw)
head(health_customers_raw)
```

## Check Account Numbers

Check if account numbers in the customer master file are the same that link to products. They aren't.

```{r}
customer_acc_nums <-
health_customers_raw %>% 
  select(PRI_ACCOUNT_NO) %>% 
  extract(col = PRI_ACCOUNT_NO, 
          into = c("PRI_ACCOUNT","SEQ"), 
          regex = ("(.*)-(.*)"), 
          remove = FALSE)
```


```{r}
length(intersect(x = unique(customer_acc_nums$PRI_ACCOUNT),
                 y = unique(health_product_holding_final$ACCOUNT_NO)))
```


## Customer Attributes

Select customer attributes which either on their own or in combination can form a unique customer identifier.

```{r}
colnames(health_customers_raw)
```

`ACCOUNT_NO` is unique for all records.

```{r}
health_customers_raw %>% 
  count(ACCOUNT_NO) %>% 
  arrange(desc(n)) %>%
  head()
```


```{r}
customer_attr <- c("ACCOUNT_NO",
                   "PRI_ACCOUNT_NO",
                   "FULL_NAMES",
                   "TELEPHONE_NUMBER",
                   "MOBILE_NUMBER",
                   "PRIMARY_EMAIL",
                   "ID_NUMBER",
                   "DATE_OF_BIRTH",
                   "MEMBER_NO",
                   "CLIENT_NO",
                   "BANK_VERIFICATION_NUMBER")
```


## Candidate unique customer identifiers

List of candidate unqiue customer identifiers.

```{r}
customer_attr_summary_health <-
health_customers_raw %>% 
  select(customer_attr) %>% 
  summarise_all(list(nulls = ~sum(is.na(.)),
                     distinct = n_distinct)) %>% 
  pivot_longer(cols = everything()) %>% 
  extract(col = name,
          into = c("field","key"), regex = "(.*)_([a-z].*)") %>% 
  pivot_wider(names_from = key, values_from = value) %>% 
  mutate(rows = nrow(health_customers_raw)) %>% 
  arrange(nulls)

customer_attr_summary_health
```

## Account Number

The format of this account number is different from that which ties the product name.

Is the `ACCOUNT_NO` unique for each customer? Yes. This means that it is a candidate for customer unique identifier across the business if it is consistent.

If the Account Number is not consistent, we can use alternative identifiers listed above.

```{r}
account_num_summary <-
health_customers_raw %>%
  filter(!is.na(ID_NUMBER), ID_NUMBER != "") %>% 
  distinct(ACCOUNT_NO,ID_NUMBER) %>% 
  count(ACCOUNT_NO,ID_NUMBER) %>% 
  arrange(desc(n)) %>% 
  head(10)

account_num_summary
```


## Conclusion

Because the account numbers on the Customer Master are different from those that contain product names, we will use those in the product names. Nonetheless, we've been able to conclude that each customer has a unique account number.

Full names is another possible unique identifier.


# GI PRODUCTS

Import everything as text.

```{r}
gi_products_1 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 1, col_types = "text")

gi_products_2 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 2, col_types = "text")

gi_products_3 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 3, col_types = "text")

gi_products_4 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 4, col_types = "text")

gi_products_5 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 5, col_types = "text")

gi_products_6 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 6, col_types = "text")

gi_products_7 <- read_xls(path = "../../../../C - Documentation/Data/festus_extraction/kenya/general/policyheader_nonlife_kenya.xls", sheet = 7, col_types = "text")
```


```{r}
gi_products_raw <-
bind_rows(gi_products_1, gi_products_2, gi_products_3, gi_products_4, gi_products_5, gi_products_6, gi_products_7) %>% 
  as.data.table()

class(gi_products_raw)
dim(gi_products_raw)
head(gi_products_raw)
```

Clean up the memory.

```{r}
rm(gi_products_1, gi_products_2, gi_products_3, gi_products_4, gi_products_5, gi_products_6, gi_products_7)
```

## Records to exclude

Field of interest: Policy Type (product), Account Number (proxy for customer number)

```{r}
gi_products_raw %>% 
  select(POLICY_TYPE, ACCOUNT_NO, ) %>% 
  mutate(null = is.na(ACCOUNT_NO)) %>% 
  count(null) %>% 
  mutate(prop = n/sum(n))
```

Check the distribution of how products have been purchased. We exclude products that have been purchased less than 10 times.

```{r}
gi_products_raw %>% 
  count(POLICY_TYPE) %>% 
  summary()
```

```{r}
insufficient_gi_purchases <-
gi_products_raw %>% 
  count(POLICY_TYPE) %>% 
  filter(n<10) %>% 
  pull(POLICY_TYPE)

insufficient_gi_purchases
```


## Product Holding

We exclude the following records:
* Those without Account Numbers
* Invalid account numbers (less than 4 characters in length)
* Products purchased less than 10 times
* Health products (health, medical)
* Life products (Accident, Work, Maxpac, Wiba)

```{r}
gi_product_holding <-
gi_products_raw %>% 
  mutate(POLICY_TYPE = str_trim(POLICY_TYPE),
         ACCOUNT_NO = str_trim(ACCOUNT_NO)) %>% 
  filter(!is.na(ACCOUNT_NO)) %>%
  filter(!str_length(ACCOUNT_NO) < 4) %>% 
  filter(!POLICY_TYPE %in% insufficient_gi_purchases) %>% 
  filter(!str_detect(string = POLICY_TYPE, pattern = "HEALTH")) %>% 
  filter(!str_detect(string = POLICY_TYPE, pattern = "MEDICAL")) %>%
  filter(!str_detect(string = POLICY_TYPE, pattern = "ACCIDENT")) %>%
  filter(!str_detect(string = POLICY_TYPE, pattern = "WORK")) %>%
  filter(!str_detect(string = POLICY_TYPE, pattern = "MAXPAC")) %>%
  filter(!str_detect(string = POLICY_TYPE, pattern = "WIBA")) %>%
  distinct(ACCOUNT_NO, POLICY_TYPE) %>% 
  count(ACCOUNT_NO, POLICY_TYPE)

dim(gi_product_holding)
head(gi_product_holding)
```

Number of products

```{r}
length(unique(gi_product_holding$POLICY_TYPE))

gi_product_holding %>% 
  distinct(POLICY_TYPE)
```

Feedback obtained from Keldine regarding the products to keep or dispose from the model.

```{r}
gi_to_keep <- read_excel(path = "./gi_products_KM_Response.xlsx") %>% 
  filter(`Keep/Rid`=="Keep") %>% 
  pull(PRODUCT)

gi_to_keep
```

```{r}
gi_product_holding_final <-
gi_product_holding %>% 
  filter(POLICY_TYPE %in% gi_to_keep)

gi_product_holding_final
```



# GI CUSTOMERS

5 worksheets.

```{r}
gi_clients_1 <-
readxl::read_xls("../../../../C - Documentation/Data/festus_extraction/kenya/general/clients_kenya.xls", sheet = 1)

gi_clients_2 <-
readxl::read_xls("../../../../C - Documentation/Data/festus_extraction/kenya/general/clients_kenya.xls", sheet = 2)

gi_clients_3 <-
readxl::read_xls("../../../../C - Documentation/Data/festus_extraction/kenya/general/clients_kenya.xls", sheet = 3)

gi_clients_4 <-
readxl::read_xls("../../../../C - Documentation/Data/festus_extraction/kenya/general/clients_kenya.xls", sheet = 4)

gi_clients_5 <-
readxl::read_xls("../../../../C - Documentation/Data/festus_extraction/kenya/general/clients_kenya.xls", sheet = 5)
```


```{r}
gi_clients_raw <- 
  bind_rows(gi_clients_1,
            gi_clients_2,
            gi_clients_3,
            gi_clients_4,
            gi_clients_5) %>%
  filter(!is.na(ACCOUNT_NO))
```


```{r}
dim(gi_clients_raw)
gi_clients_raw
```


```{r}
rm(gi_clients_1,gi_clients_2,gi_clients_3,gi_clients_4,gi_clients_5)
```


## Candidate unique customer identifier

```{r}
customer_attr
```
Bind all records

```{r}
gi_clients_all <- 
  bind_rows(gi_clients_1,gi_clients_2,gi_clients_3,gi_clients_4,gi_clients_5)
```



```{r}
customer_attr_summary_gi <-
gi_clients_all %>% 
  select(customer_attr) %>% 
  summarise_all(list(nulls = ~sum(is.na(.)),
                     distinct = n_distinct)) %>% 
  pivot_longer(cols = everything()) %>% 
  extract(col = name,
          into = c("field","key"), regex = "(.*)_([a-z].*)") %>% 
  pivot_wider(names_from = key, values_from = value) %>% 
  mutate(rows = nrow(gi_clients_all)) %>%
  arrange(nulls)

customer_attr_summary_gi
```
Do the blank Account Numbers contain data? Yes, some even have KRA PIN.

```{r}
gi_clients_all %>% 
  filter(is.na(ACCOUNT_NO)) %>% 
  head()
```


## Conclusion

The client number or full names are possible unique customer identifier.

# LIFE PRODUCTS

Import ACCOUNT_NO, CONTRACT_GROUP_NAME, CONTRACT_VERSION

```{r}
life_products_raw <-
read_csv(file = "../../../../C - Documentation/Data/festus_extraction/kenya/life/new/Kenya Life Policies and Policy Details.csv") %>% 
  unite(col = PRODUCT, c(CONTRACT_GROUP_NAME,CONTRACT_VERSION), sep = "_") %>% 
  select(ACCOUNT_NO, PRODUCT) %>% 
  mutate(PRODUCT = str_remove(string = PRODUCT, pattern = "_NA$"))

head(life_products_raw)
```

## Products to exclude

We can remove products purchased less than 10 times.

```{r}
life_products_raw %>% 
  count(PRODUCT, sort = TRUE) %>% 
  summary()
```

```{r}
insufficient_life_purchases <-
life_products_raw %>% 
  count(PRODUCT, sort = TRUE) %>% 
  filter(n<10) %>% 
  pull(PRODUCT)

insufficient_life_purchases
```

## Product Holding

```{r}
life_product_holding <-
life_products_raw %>% 
  filter(!PRODUCT %in% insufficient_life_purchases) %>% 
  distinct(ACCOUNT_NO, PRODUCT) %>% 
  count(ACCOUNT_NO, PRODUCT)

life_product_holding
```

Sense checking

```{r}
life_product_holding %>% 
  count(ACCOUNT_NO, PRODUCT, sort = TRUE)
```


# ASSET MGT PRODUCTS


```{r}
asset_mgt_products_raw <-
read_csv("../../../../C - Documentation/Data/festus_extraction/kenya/asset_mgt/Investment Account Dataset.csv")
```


```{r}
head(asset_mgt_products_raw)
```

## Products Holding

```{r}
asset_product_holding <-
asset_mgt_products_raw %>% 
  distinct(ACCOUNT_NO,FUND_NAME) %>% 
  count(ACCOUNT_NO,FUND_NAME) %>% 
  arrange(desc(n))

head(asset_product_holding)
```

## Number of products

```{r}
length(unique(asset_product_holding$FUND_NAME))
```

```{r}
asset_product_holding %>% 
  count(FUND_NAME) %>% 
  arrange(desc(n))
```


```{r}
asset_mgt_products <-
asset_product_holding %>% 
  count(FUND_NAME) %>% 
  arrange(desc(n)) %>% 
  filter(str_detect(string = FUND_NAME,
                    pattern = "Old Mutual.*") | 
         str_detect(string = FUND_NAME,
                    pattern = ".* Plan")) %>% 
  pull(FUND_NAME)
```


## Relevant products [FINAL]

```{r}
asset_product_holding_final <-
asset_product_holding %>% 
  filter(FUND_NAME %in% asset_mgt_products)

dim(asset_product_holding_final)
head(asset_product_holding_final)
```

## Check NAs

```{r}
asset_product_holding_final %>% 
  filter(is.na(n))
```

# ASSET MGT CUSTOMERS

```{r}
asset_mgt_customers_raw <-
read_csv("../../../../C - Documentation/Data/festus_extraction/kenya/asset_mgt/Customer Dataset.csv") %>% 
  select(-starts_with("X"))
```


## Check Account Number

The Account Numbers in the product and customer master files are similar.

```{r}
length(intersect(x = asset_mgt_customers_raw$ACCOUNT_NO,
                 y = asset_product_holding_final$ACCOUNT_NO))
```


## Customer identifier


```{r}
head(asset_mgt_customers_raw)
```

Account Numbers are unique per customer.

```{r}
customer_attr_summary_asset <-
asset_mgt_customers_raw %>% 
  select(customer_attr) %>% 
  summarise_all(list(nulls = ~sum(is.na(.)),
                     distinct = n_distinct)) %>% 
  pivot_longer(cols = everything()) %>% 
  extract(col = name,
          into = c("field","key"), regex = "(.*)_([a-z].*)") %>% 
  pivot_wider(names_from = key, values_from = value) %>%
  mutate(rows = nrow(asset_mgt_customers_raw)) %>% 
  arrange(nulls)

customer_attr_summary_asset
```


## Conclusion

Account Number and Full Names are possible unique customer identifiers.

# GROUP CUSTOMER IDENTIFIER

* Health - Account Number (in products)
* GI - Client Number, Full Names (in customers, we wait for products)
* Asset management - Account Number (in products)
* Life - TBD

## Way forward

We proceed with Health and Asset Management

## Match Account Numbers

Health and Asset Management.

```{r}
length(unique(health_product_holding_final$ACCOUNT_NO))

length(unique(asset_product_holding_final$ACCOUNT_NO))
```
Some Account Numbers in Health and Asset Mgt match.

```{r}
length(
    intersect(
      unique(health_product_holding_final$ACCOUNT_NO),
      unique(asset_product_holding_final$ACCOUNT_NO)))
```

## Conclusion

Account Number (in products) can be a common unique customer identifier between Health and Asset Management.


# LIMITATIONS

1. Health: It is not possible to link an individual policy to the customer master.


# EXPORT

```{r}
save.image(file = "./01Apr-Customer_Matching.RData")
load("./01Apr-Customer_Matching.RData")
```


```{r}
# Health product holdings
saveRDS(object = health_product_holding_final, 
        file = "./product_holding/health_product_holding_final.rds")

# Asset mgt product holdings
saveRDS(object = asset_product_holding_final, 
        file = "./product_holding/asset_product_holding_final.rds")

# General insurance product holding
saveRDS(object = gi_product_holding_final, 
        file = "./product_holding/gi_product_holding_final.rds")

# Life insurance product holding
saveRDS(object = life_product_holding,
        file = "./product_holding/life_product_holding.rds")

# GI Accounts
saveRDS(object = gi_products_raw,
        file = "./gi_products_raw.rds")

# GI clients
saveRDS(object = gi_clients_raw, file = "./gi_clients_raw.rds")

# Project image
save.image(file = "./21Apr_Product_Cust_Matching.RData")
load("./20Apr_Product_Cust_Matching.RData")
```









