---
title: "Product-Customer Matching"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(readxl)
library(data.table)
library(tidyverse)
```

# GENERAL INS

## Data exploration

Locating the unique customer identifier.

* `ACCOUNT_NO` is a unique customer identifier.
* `BUSINESS_TYPE` represents the product name.
* `POLICY_NO` is the unique contract id. 

```{r}
# Import id column as character
general_products <- 
  read_excel("../../../../../../Sudan/GI/policyheader_nonlife_sudan.xls") %>% 
  mutate(ACCOUNT_NO = as.character(ACCOUNT_NO))
```


```{r}
general_products %>% 
  count(ACCOUNT_NO)

general_products %>% 
  filter(ACCOUNT_NO=="3013303095")

general_products %>% 
  count(PLAN_NAME)

general_products %>% 
  count(POLICY_TYPE)
```

## Product holding

The table below returns a table showing products held by each account (1 product, 1 account). n should be 1 in all cases.

```{r}
general_product_holding_raw <-
general_products %>% 
  distinct(ACCOUNT_NO,POLICY_TYPE) %>% 
  count(ACCOUNT_NO,POLICY_TYPE)

general_product_holding_raw
```

Because GI products are very many, we filter out general insurance products that don't have a lot of uptake.

```{r}
insufficent_products <-
general_product_holding_raw %>% 
  count(POLICY_TYPE, sort = TRUE) %>% 
  filter(n<=15) %>% 
  pull(POLICY_TYPE)

insufficent_products
```

```{r}
general_product_holding <-
general_product_holding_raw %>% 
  filter(!POLICY_TYPE %in% insufficent_products) %>%
  filter(!is.na(ACCOUNT_NO))

general_product_holding
```

## Sense checks

```{r}
general_product_holding %>% 
  distinct(n)

anyNA(general_product_holding)

general_product_holding %>% 
  count(POLICY_TYPE)
```



# HEALTH INSURANCE

```{r}
health_products_raw <- 
  fread(file = "../../../../../../Sudan/Health/policyheader_nonlife_sudan.csv")

head(health_products_raw)
```
```{r}
health_prod_holding <-
health_products_raw %>% 
  rename(PRODUCT = POLICY_TYPE) %>%
  distinct(ACCOUNT_NO, `PRODUCT`) %>% 
  filter (!`PRODUCT` == "NULL") %>%
  count(ACCOUNT_NO,`PRODUCT`) %>% 
  arrange(desc(n))

health_prod_holding %>%
  distinct(`PRODUCT`)
```
```{r}
health_prod_holding %>% 
  count(ACCOUNT_NO) %>% 
  arrange(desc(n))
```
```{r}
health_prod_holding %>% 
  count(n, sort=TRUE)
```

```{r}
health_product_holding_final <- health_prod_holding %>%
    filter (!is.na(ACCOUNT_NO)) %>%
    rename("Product" = "PRODUCT")

dim(health_product_holding_final)
dim(health_prod_holding)
```

```{r}
health_product_holding_final %>% 
  count(Product) %>% 
  arrange(desc(n))
```
```{r}
health_product_holding_final <- health_product_holding_final %>% 
  mutate(n = replace_na(1))
```

```{r}
anyNA(health_prod_holding)

health_prod_holding
```

# EXPORT

```{r}
# save.image(file = "../outputs/23June.RData")
# load(file = "../outputs/23June.RData")
# 
# saveRDS(object = general_product_holding, 
#         file = "../outputs/general_product_holding.rds")

saveRDS(object = health_prod_holding, 
        file = "../outputs/health_product_holding.rds")
```









