---
title: "Product-Customer Matching"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(readxl)
library(data.table)
library(tidyverse)
```

# GENERAL INS

## Data exploration

Locating the unique customer identifier.

* `ACCOUNT_NO` is a unique customer identifier.
* `BUSINESS_TYPE` represents the product name.
* `POLICY_NO` is the unique contract id. 

```{r}
# Import id column as character
general_products <- 
  read_excel("../../../../../../Sudan/GI/policyheader_nonlife_sudan.xls") %>% 
  mutate(ACCOUNT_NO = as.character(ACCOUNT_NO))
```


```{r}
general_products %>% 
  count(ACCOUNT_NO)

general_products %>% 
  filter(ACCOUNT_NO=="3013303095")

general_products %>% 
  count(PLAN_NAME)

general_products %>% 
  count(POLICY_TYPE)
```

## Product holding

The table below returns a table showing products held by each account (1 product, 1 account). n should be 1 in all cases.

```{r}
general_product_holding_raw <-
general_products %>% 
  distinct(ACCOUNT_NO,POLICY_TYPE) %>% 
  count(ACCOUNT_NO,POLICY_TYPE)

general_product_holding_raw
```

Because GI products are very many, we filter out general insurance products that don't have a lot of uptake.

```{r}
insufficent_products <-
general_product_holding_raw %>% 
  count(POLICY_TYPE, sort = TRUE) %>% 
  filter(n<=15) %>% 
  pull(POLICY_TYPE)

insufficent_products
```

```{r}
general_product_holding <-
general_product_holding_raw %>% 
  filter(!POLICY_TYPE %in% insufficent_products) %>%
  filter(!is.na(ACCOUNT_NO))

general_product_holding
```

## Sense checks

```{r}
general_product_holding %>% 
  distinct(n)

anyNA(general_product_holding)

general_product_holding %>% 
  count(POLICY_TYPE)
```

# EXPORT

```{r}
save.image(file = "../outputs/23June.RData")
load(file = "../outputs/23June.RData")

saveRDS(object = general_product_holding, 
        file = "../outputs/general_product_holding.rds")
```









