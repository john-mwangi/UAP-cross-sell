---
title: "Product-Customer Matching"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(readxl)
library(data.table)
library(tidyverse)
```

# GENERAL INS

## Data exploration

Locating the unique customer identifier.

* `ACCOUNT_NO` is a unique customer identifier.
* `BUSINESS_TYPE` represents the product name.
* `POLICY_NO` is the unique contract id. 

```{r}
# Import id column as character
general_products <- 
  read_excel("../../../../../../Sudan/GI/policyheader_nonlife_sudan.xls") %>% 
  mutate(ACCOUNT_NO = as.character(ACCOUNT_NO))
```


```{r}
general_products %>% 
  count(ACCOUNT_NO)

general_products %>% 
  filter(ACCOUNT_NO=="3013303095")

general_products %>% 
  count(PLAN_NAME)

general_products %>% 
  count(POLICY_TYPE)
```

## Product holding

The table below returns a table showing products held by each account (1 product, 1 account). n should be 1 in all cases.

```{r}
general_product_holding_raw <-
general_products %>% 
  distinct(ACCOUNT_NO,POLICY_TYPE) %>% 
  count(ACCOUNT_NO,POLICY_TYPE)

general_product_holding_raw
```

Because GI products are very many, we filter out general insurance products that don't have a lot of uptake.

```{r}
insufficent_products <-
general_product_holding_raw %>% 
  count(POLICY_TYPE, sort = TRUE) %>% 
  filter(n<=15) %>% 
  pull(POLICY_TYPE)

insufficent_products
```

```{r}
general_product_holding <-
general_product_holding_raw %>% 
  filter(!POLICY_TYPE %in% insufficent_products)

general_product_holding
```

## Sense checks

```{r}
general_product_holding %>% 
  distinct(n)

anyNA(general_product_holding)

general_product_holding %>% 
  count(POLICY_TYPE)
```


# LIFE INS

## Data exploration

Merge all extracts together.

```{r}
gibbs_raw <- read_excel(path = "../../../../../../C - Documentation/Data/festus_extraction/NG/life/policy_header/Policy_Header_Life.csv_gibbs_life.xlsx")

compen_raw <- read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/NG/life/policy_header/Policy_Life_20210504_compen_life.csv")

oipa_raw <- read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/NG/life/policy_header/PolicyHeaderLife_20210301_195929_oipa_life.csv")
```

### gibbs

* `ACCOUNT_NUMBER` is the unique customer identifier.
* `CONTRACT_GROUP_NAME` is the product name column

```{r}
gibbs_raw

gibbs_raw %>% 
  count(ACCOUNT_NUMBER, sort = TRUE)

gibbs_raw %>% 
  filter(ACCOUNT_NUMBER=="001/HO/001/L07/607")
```

### compen

This is test data.

```{r}
compen_raw
```

### oipa

* `ACCOUNT_NUMBER` is the unique customer identifier
* `CONTRACT_GROUP_NAME` is the product name column.

```{r}
oipa_raw %>% 
  count(ACCOUNT_NUMBER, sort = TRUE)

oipa_raw %>% 
  filter(ACCOUNT_NUMBER=="0000001045")
```

## Life products

Merge all products from different life insurance systems into one.

```{r}
life_products <-
rbind(
  gibbs_raw %>% 
    select(ACCOUNT_NUMBER, CONTRACT_GROUP_NAME, AGENT_CONTRACT_ID, CONTRACT_ID),
  oipa_raw %>% 
    select(ACCOUNT_NUMBER, CONTRACT_GROUP_NAME, AGENT_CONTRACT_ID, CONTRACT_ID)
  )

life_products
```


## Product holding

```{r}
life_product_holding <-
  life_products %>% 
  distinct(ACCOUNT_NUMBER,CONTRACT_GROUP_NAME) %>% 
  count(ACCOUNT_NUMBER, CONTRACT_GROUP_NAME)

life_product_holding
```

## Sense checks

```{r}
anyNA(life_product_holding)

life_product_holding %>% 
  distinct(n)

life_product_holding %>% 
  count(CONTRACT_GROUP_NAME)
```

# EXPORT

```{r}
save.image(file = "../outputs/02June.RData")
load(file = "../outputs/02June.RData")

saveRDS(object = general_product_holding, 
        file = "../outputs/general_product_holding.rds")
saveRDS(object = life_product_holding, 
        file = "../outputs/life_product_holding.rds")
saveRDS(object = life_products,
        file = "../outputs/life_products.rds")
```









