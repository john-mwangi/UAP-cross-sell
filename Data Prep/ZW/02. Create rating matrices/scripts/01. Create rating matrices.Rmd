---
title: "Cross-sell Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(dtplyr)
library(data.table)
library(recommenderlab)
library(tidyverse)
```


# Import Data

```{r}
asset_product_holding <- readRDS(file = "../../01. Determine product holding/outputs/objects/asset_product_holding.rds")

gi_product_holding <- readRDS(file = "../../01. Determine product holding/outputs/objects/gi_product_holding.rds")

life_product_holding <- readRDS(file = "../../01. Determine product holding/outputs/objects/life_product_holding.rds")

lending_product_holding <- readRDS("../../01. Determine product holding/outputs/objects/lending_product_holding.rds")

banking_product_holding <- readRDS("../../01. Determine product holding/outputs/objects/banking_product_holding.rds")
```

# Merge the tables

Ensure customer-product combination is unique across the subsidiary.

```{r}
products_df_raw_query <-
rbind(asset_product_holding,
      life_product_holding,
      gi_product_holding,
      lending_product_holding,
      banking_product_holding) %>% 
  lazy_dt() %>% 
  group_by(UNIQUE_ID) %>% 
  mutate(ACCOUNT_NO = paste0(unique(ACCOUNT_NO), collapse = ",")) %>% 
  ungroup() %>% 
  distinct(UNIQUE_ID, PRODUCT, .keep_all = TRUE) %>% 
  select(-n) %>% 
  add_count(UNIQUE_ID,PRODUCT)
```


```{r}
products_df_raw <- products_df_raw_query %>% as.data.table() %>% select(-.add)

products_df_raw
```


# Overall product holding

On average, people purchase just one product.

```{r eval=FALSE, include=FALSE}
products_df_raw %>% 
  count(UNIQUE_ID) %>% 
  summary()
```

```{r eval=FALSE, include=FALSE}
purchase_dist <-
products_df_raw %>% 
  count(UNIQUE_ID) %>% 
  mutate(n = pmin(2, n)) %>% 
  ggplot(aes(n))+
  geom_histogram(binwidth = 0.5)+
  #scale_y_log10(labels = scales::comma_format())+
  scale_x_continuous(breaks = c(1,2),
                     labels = c(1,"+2"))+
  stat_bin(binwidth=1, 
           geom="text", 
           aes(label=paste0(..count..,"/",round(..count../sum(..count..), 2))), 
           vjust=0.25)+
  labs(title = "Distribution of product purchases",
       x = "Purchases",
       y = "Purchase Frequency")

purchase_dist
```


# Create dummy variables

```{r}
products_df <-
products_df_raw %>%
  pivot_wider(names_from = PRODUCT, 
              values_from = n, 
              values_fill = 0)

products_df
```


# Convert to matrix

```{r}
products_matrix <-
products_df %>% 
  select(-UNIQUE_ID, -ACCOUNT_NO) %>% 
  as.matrix()

rownames(products_matrix) <- products_df %>% pull(UNIQUE_ID)
```

# Sense check

Check for NA values in the product names.

```{r}
products_matrix %>% 
  colnames() %>% 
  str_detect(string = ., pattern = "NA") %>% 
  sum()
```

```{r}
rownames(products_matrix)[1:10]
colnames(products_matrix)[1:10]
```


# Convert to binaryRatingMatrix

```{r}
products_rating_matrix <- as(products_matrix, "binaryRatingMatrix")
```


```{r}
class(products_rating_matrix)
dim(products_rating_matrix)
```

# Notes

It should be indicated on the app that Account Number is:
* Asset Mgt: ACCOUNT_NUMBER
* General Ins: CUSTOMER_NO
* Life Ins: ACCOUNT_NUMBER
* Lending: account_no
* Banking: ACCOUNT_NUMBER


# Export

```{r}
saveRDS(object = products_rating_matrix, 
        file = "../outputs/products_rating_matrix.rds")

save.image("../outputs/24June_RatingMatrix.RData")
#load("./05May_RatingMatrix.RData")
```

