---
title: "Product values"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(readxl)
library(lubridate)
library(tidyverse)
```


# PRODUCT BUSINESS LINES

```{r}
product_businesslines <- readRDS("../outputs/product_businesslines.rds")

product_businesslines
```


# ASSET MGT

Tie values in the statements to product names in the customer datasets.

## Statements

Transaction types to included:
* Creation

Purchases are top-ups after Creation.

```{r}
asset_statements <-
read.csv(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/statement_investment.csv",
  sep = ";")

asset_statements %>% 
  filter(AMOUNT > 0) %>% 
  count(TRANSACTION_TYPE_DETAIL)
```


## Product names

```{r}
asset_products <-
asset_statements %>% 
  mutate(TRANSACTION_DATE = ymd(TRANSACTION_DATE)) %>% 
  filter(AMOUNT > 0) %>% 
  filter(TRANSACTION_DATE >= "2018-01-01") %>% 
  filter(TRANSACTION_TYPE_DETAIL %in% c("Creation","Stock Creation")) %>% 
  rename(OLD_NAME = PRODUCT)

asset_products
```
## Fix product names

```{r}
asset_products_cleaned <-
read_excel(path = "../../../../../../C - Documentation/Data/festus_extraction/ZW/supp_product_details.xlsx",
           sheet = "Asset_Products") %>% 
  janitor::clean_names() %>% 
  rename(OLD_NAME = in_statements_file,
         PRODUCT = in_customer_file)

asset_products_cleaned
```


```{r}
asset_product_values <-
asset_products %>% 
  left_join(asset_products_cleaned, by = "OLD_NAME") %>%
  group_by(PRODUCT) %>% 
  summarise(product_value = mean(AMOUNT),
            accounts = n())

asset_product_values
```


# LIFE INSURANCE

## Product values

```{r}
life_product_values <-
read.csv(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/statement_life_insurance.oipa.csv") %>%
  filter(PAYMENT_PAID > 0) %>% 
  mutate(TRANSACTION_DATE = ymd(TRANSACTION_DATE)) %>% 
  filter(TRANSACTION_DATE >= "2018-01-01") %>% 
  select(PRODUCT,PAYMENT_PAID,TRANSACTION_TYPE,TRANSACTION_DATE) %>% 
  group_by(PRODUCT) %>%
  summarise(product_value = mean(PAYMENT_PAID),
            accounts = n())

life_product_values
```

# GENERAL INSURANCE

## Statements

```{r}
gi_prod_vals_raw <-
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/statement_general_insurance.csv") %>% 
  mutate(TRANSACTION_DATE = ymd(TRANSACTION_DATE)) %>% 
  filter(TRANSACTION_DATE >= "2018-01-01") %>% 
  filter(PREMIUM_AMOUNT > 0) %>% 
  select(POLICY_PRODUCT_TYPE, PREMIUM_AMOUNT, TRANSACTION_TYPE)

gi_prod_vals_raw
```
## Product names

```{r}
gi_product_names <-
readxl::read_excel(
  path = "../../../../../../C - Documentation/Data/festus_extraction/ZW/supp_product_details.xlsx",
  sheet = "GI") %>% 
  select(`PROD-TYPE`,DESCRIPTION)

gi_product_names
```

## Product values

```{r}
gi_product_values <-
gi_prod_vals_raw %>% 
  left_join(gi_product_names, by = c("POLICY_PRODUCT_TYPE"="PROD-TYPE")) %>% 
  select(-POLICY_PRODUCT_TYPE) %>% 
  rename(PRODUCT = DESCRIPTION) %>% 
  relocate(PRODUCT, .before = everything()) %>% 
  group_by(PRODUCT) %>% 
  summarise(product_value = mean(PREMIUM_AMOUNT),
            accounts = n())

gi_product_values
```


# LENDING

## Products values

```{r}
lending_product_values <-
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/statement_lending.csv") %>% 
  mutate(income = total_repaid - principal) %>% 
  filter(income > 0) %>% 
  select(PRODUCT = product_name, income) %>% 
  group_by(PRODUCT) %>% 
  summarise(product_value = mean(income),
            accounts = n())

lending_product_values
```

# ALL PRODUCTS

```{r}
product_values_raw <-
rbind(asset_product_values,
      life_product_values,
      gi_product_values,
      lending_product_values)
```


# MISSING

Check that all products have assigned product values and impute.

```{r}
product_businesslines %>% 
  left_join(product_values_raw) %>% 
  filter(is.na(product_value)) %>% 
  filter(BUSINESS_LINE != "Banking")
```


```{r}
product_values <-
product_businesslines %>%
  left_join(product_values_raw, by = "PRODUCT") %>% 
  group_by(BUSINESS_LINE) %>%
  mutate(product_value = replace_na(product_value, 
                                    mean(product_value, na.rm = TRUE))) %>% 
  ungroup() %>% 
  mutate(product_value = if_else(condition = is.nan(product_value), 
                                 true = 99999, 
                                 false = product_value)) %>% 
  mutate(product_value = round(product_value)) %>% 
  select(-BUSINESS_LINE)

product_values 
```

# EXPORT

```{r}
save.image("../outputs/22June_Product_Values.RData")
#load("../outputs/16May_Product_Values.RData")

saveRDS(product_values,"../outputs/product_values.rds")
```

