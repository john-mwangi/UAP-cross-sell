---
title: "Customer details"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(recommenderlab)
library(glue)
library(data.table)
library(dtplyr)
library(readxl)
library(digest)
library(tidyverse)
```

# OBJECTIVE

When hovering on a customer in the app, it should display whether a customer is intermediated (and agent code) and product details (number and name of products).

Extract the following details:
* Agent code tied to a customer
* Number of products held by a customer across the subsidiary and their names
* Business lines that owns the customer across the subsidiary
* Merge products held and agent code into a single column

# AGENT DETAILS

## Asset Mgt

`ACCOUNT_NUMBER` is the unique customer identifier.

```{r}
asset_customers_raw <- read.csv(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_investment.csv", 
  sep = ";", 
  na.strings = c(""," ")) %>% 
  filter(ACCOUNT_NUMBER > 10000) %>% 
  select(UNIQUE_ID = ACCOUNT_NUMBER, AGENT_CODE) %>% 
  mutate(UNIQUE_ID = as.character(UNIQUE_ID)) %>% 
  mutate(intermediated = if_else(condition = is.na(AGENT_CODE), 
                                 true = "No", 
                                 false = "Yes"))

asset_customers_raw
```

## General Insurance

`CUSTOMER_NO` is the unique customer identifier.

```{r}
gi_customers_raw <-
read.csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_general_insurance.csv") %>% 
  select(UNIQUE_ID = CUSTOMER_NO,AGENT_CODE) %>% 
  mutate(intermediated = if_else(condition = is.na(AGENT_CODE), 
                                 true = "No", 
                                 false = "Yes")) %>% 
  mutate(UNIQUE_ID = as.character(UNIQUE_ID))

gi_customers_raw
```

## Life Insurance

`NATIONAL_ID` is the unique customer identifier.

```{r}
life_customers_raw <-
read.csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_life_insurance.oipa.csv",
         sep = ";",
         na.strings = c("," )) %>% 
  filter(str_length(CUSTOMER_NUMBER) > 0) %>% 
  filter(!is.na(ACCOUNT_NUMBER)) %>% 
  filter(!is.na(NATIONAL_ID)) %>% 
  mutate(UNIQUE_ID = map_chr(.x = NATIONAL_ID,
                             .f = ~digest(object = .,
                                          algo = "sha256",
                                          serialize = FALSE))) %>% 
  select(UNIQUE_ID, AGENT_CODE) %>% 
  mutate(intermediated = if_else(condition = is.na(AGENT_CODE), 
                                 true = "No", 
                                 false = "Yes"))

life_customers_raw
```

## Lending

`national_id` is the customer identifier.

```{r}
lending_customers_raw <-
read_csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_lending.csv") %>% 
  mutate(UNIQUE_ID = map_chr(.x = national_id,
                             .f = ~digest(object = .,
                                          algo = "sha256",
                                          serialize = FALSE))) %>% 
  select(UNIQUE_ID) %>%
  mutate(AGENT_CODE = NA,
         intermediated = "No")

lending_customers_raw
```

## Banking

### T24

```{r}
t24_customers_raw <-
fread(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_t24_banking.csv",
      na.strings = "") %>% 
  select(NATIONAL_ID, AGENT_CODE) %>% 
  filter(!is.na(NATIONAL_ID)) %>% 
  mutate(intermediated = if_else(condition = is.na(AGENT_CODE),
                                 true = "No",
                                 false = "Yes")) %>% 
  mutate(UNIQUE_ID = map_chr(.x = NATIONAL_ID, 
                             .f = ~digest(object = .,
                                          algo = "sha256",
                                          serialize = FALSE))) %>% 
  select(UNIQUE_ID, AGENT_CODE, intermediated) %>% 
  distinct(UNIQUE_ID, .keep_all = TRUE)

t24_customers_raw
```

### Postilion

```{r}
post_customers_raw <-
fread(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_postilion_banking.csv",
      na.strings = "") %>% 
  select(UNIQUE_ID = CUSTOMER_NUMBER, AGENT_CODE) %>% 
  mutate(intermediated = if_else(condition = is.na(AGENT_CODE),
                                 true = "No",
                                 false = "Yes")) %>% 
  select(UNIQUE_ID, AGENT_CODE, intermediated) %>% 
  distinct(UNIQUE_ID, .keep_all = TRUE)

post_customers_raw
```

### Banking

```{r}
banking_customers_raw <- rbind(t24_customers_raw, post_customers_raw)
```


## Customer agents

```{r}
customer_agents <-
rbind(asset_customers_raw,
      life_customers_raw,
      gi_customers_raw,
      lending_customers_raw,
      banking_customers_raw) %>% 
  distinct(UNIQUE_ID, .keep_all = TRUE)

customer_agents
```


# ACCOUNT INFO

Across the subsidiary

## Product count

```{r}
products_rating_matrix <-
readRDS(file = "../../02. Create rating matrices/outputs/products_rating_matrix.rds")

dim(products_rating_matrix)
```


```{r}
product_count <-
as(products_rating_matrix, "data.frame") %>% 
  select(user, item) %>% 
  count(user, name = "product_count") %>% 
  rename(UNIQUE_ID = user)

# Check
product_count %>% 
  filter(str_detect(UNIQUE_ID,"aa4436b5c9b1d24ee8b3edebf8dff415f6cb1297081fc7d9db38e8fc6aae6697"))
```


## Customer products

```{r}
customer_products_query <-
as(products_rating_matrix, "data.frame") %>%
  lazy_dt() %>% 
  group_by(user) %>% 
  mutate(products = paste0(item, collapse = ", ")) %>% 
  distinct(user, .keep_all = TRUE) %>% 
  select(UNIQUE_ID = user, products) %>% 
  ungroup()
```


```{r}
customer_products <- customer_products_query %>% as.data.table()

customer_products
```


## Ownership

Define business lines to which products belong to.

```{r}
asset_products <-
readRDS(file = "../../01. Determine product holding/outputs/objects/asset_product_holding.rds") %>% 
  distinct(PRODUCT) %>%
  mutate(BUSINESS_LINE = "Asset")

gi_products <-
readRDS(file = "../../01. Determine product holding/outputs/objects/gi_product_holding.rds") %>% 
  distinct(PRODUCT) %>%
  mutate(BUSINESS_LINE = "General")

life_products <-
readRDS(file = "../../01. Determine product holding/outputs/objects/life_product_holding.rds") %>%
  distinct(PRODUCT) %>%
  mutate(BUSINESS_LINE = "Life")

lending_products <-
readRDS(file = "../../01. Determine product holding/outputs/objects/lending_product_holding.rds") %>%
  ungroup() %>% 
  distinct(PRODUCT) %>%
  mutate(BUSINESS_LINE = "Lending")

banking_products <-
readRDS(file = "../../01. Determine product holding/outputs/objects/banking_product_holding.rds") %>% 
  distinct(PRODUCT) %>% 
  mutate(BUSINESS_LINE = "Banking")
```

## Product businesslines

```{r}
product_businesslines <-
rbind(asset_products,
      life_products,
      gi_products,
      lending_products,
      banking_products)

product_businesslines
```


```{r}
customer_ownership_query <-
as(products_rating_matrix, "data.frame") %>% 
  lazy_dt() %>% 
  select(UNIQUE_ID = user, PRODUCT = item) %>% 
  left_join(product_businesslines, by = "PRODUCT") %>% 
  group_by(UNIQUE_ID) %>% 
  mutate(ownership = paste0(unique(BUSINESS_LINE), collapse = ", ")) %>% 
  select(UNIQUE_ID, ownership) %>% 
  distinct(UNIQUE_ID, .keep_all = TRUE) %>% 
  ungroup()
```


```{r}
customer_ownership <- customer_ownership_query %>% as.data.table()

customer_ownership
```


## Account summaries

Summarise information concerning an account:
* Business line of the account
* Agent tied to the account

Product tied to the account - some customers have up to 61 accounts and 23 products. What will be displayed is the Account Number and the Business Line of the Account and using that information, the source system can be queried for further details of the product and customer.


Steps:
- Merge all product holdings
- Join with customer agents
- Summarise by unique_id
- Check if

A table of individual accounts and the business lines to which they belong.

```{r}
account_businesslines <-
rbind(readRDS(file = "../../01. Determine product holding/outputs/objects/asset_product_holding.rds") %>% 
      mutate(BUSINESS_LINE = "Asset"),
  
      readRDS(file = "../../01. Determine product holding/outputs/objects/gi_product_holding.rds") %>% 
      mutate(BUSINESS_LINE = "General"),
  
      readRDS(file = "../../01. Determine product holding/outputs/objects/lending_product_holding.rds") %>% 
      mutate(BUSINESS_LINE = "Lending"),
  
      readRDS(file = "../../01. Determine product holding/outputs/objects/life_product_holding.rds") %>% 
      mutate(BUSINESS_LINE = "Life"),
      
      readRDS(file = "../../01. Determine product holding/outputs/objects/banking_product_holding.rds") %>% 
      mutate(BUSINESS_LINE = "Banking")) %>% 
  
  select(UNIQUE_ID, ACCOUNT_NO, BUSINESS_LINE) %>% 
  distinct(UNIQUE_ID, BUSINESS_LINE, .keep_all = TRUE)

# Check
account_businesslines %>% 
  filter(str_detect(UNIQUE_ID,"aa4436b5c9b1d24ee8b3edebf8dff415f6cb1297081fc7d9db38e8fc6aae6697"))
```

Summarise customer details by the business line.

```{r}
account_summaries <-
account_businesslines %>% 
  left_join(customer_agents, by = "UNIQUE_ID") %>%
  group_by(UNIQUE_ID) %>% 
  mutate(businessline_details = paste0("Business line:",BUSINESS_LINE,
                                       "\nAccount no:",ACCOUNT_NO, 
                                       "\nAgent code:",AGENT_CODE, 
                                       collapse = "\n\n")) %>% 
  distinct(UNIQUE_ID, .keep_all = TRUE) %>% 
  select(UNIQUE_ID, ACCOUNT_NO, businessline_details) %>% 
  ungroup()

account_summaries
```

## Sense check

```{r}
account_summaries %>% 
  filter(UNIQUE_ID=="107793")


account_summaries %>% 
  filter(str_detect(string = businessline_details, pattern = "1125337966"))
```

## Account info

```{r}
account_info <-
customer_products %>% 
  left_join(product_count, by = "UNIQUE_ID") %>% 
  left_join(customer_ownership, by = "UNIQUE_ID") %>% 
  left_join(account_summaries, by = "UNIQUE_ID")

account_info
```

## Sense check

```{r}
account_info %>% 
  count(ownership)

summary(account_info$product_count)

account_info %>% 
  filter(product_count==max(product_count))

account_info %>% 
  filter(UNIQUE_ID=="107793")

account_info %>% 
  filter(UNIQUE_ID=="00064081170259dce6faccfe4bf69ad82d7e94315c5bf69599326b89fafb9155")

account_info %>% 
  select(UNIQUE_ID, ACCOUNT_NO, ownership) %>% 
  mutate(num_accounts = map_dbl(.x = ACCOUNT_NO, 
                                .f = ~str_count(string = ., pattern = ",") + 1
                                )
         ) %>% 
  arrange(desc(num_accounts)) %>% 
  filter(str_detect(string = ownership, pattern = ",")) %>%
  filter(str_detect(string = ACCOUNT_NO, pattern = ",")) %>% 
  #filter(num_accounts==5) %>% 
  head(1)

account_info %>% 
  filter(ownership=="Life, Lending")


account_info %>% 
  filter(str_detect(UNIQUE_ID,"aa4436b5c9b1d24ee8b3edebf8dff415f6cb1297081fc7d9db38e8fc6aae6697"))
```


# CUSTOMER DETAILS

Merge account and agent information.

```{r}
customer_details_final <-
account_info %>% 
  left_join(customer_agents, by = "UNIQUE_ID") %>% 
  select(-AGENT_CODE) %>% 
  relocate(intermediated, .before = businessline_details) %>%
  mutate(customer_details = glue("Product holding:{product_count}
                                 Products:{products}
                                 {businessline_details}",
                                 .na = "Not Found")) %>% 
  select(UNIQUE_ID, ownership, intermediated, customer_details)

customer_details_final
```

# EXPORT

```{r}
# Detailed Recommendations
saveRDS(object = customer_details_final, 
        file = "../outputs/customer_details_final.rds")

#Product business lines
saveRDS(product_businesslines,"../outputs/product_businesslines.rds")

# Project image
save.image("../outputs/08July_Customer_details.RData")
load("../outputs/08July_Customer_details.RData")
```



