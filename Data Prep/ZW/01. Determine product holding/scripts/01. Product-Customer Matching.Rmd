---
title: "Product-Customer Matching"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PACKAGES

```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(readxl)
library(data.table)
library(tidyverse)
```

# ASSET MGT

## Data exploration

Locating the unique customer identifier.

```{r}
asset_products_raw <- read.csv(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_investment.csv", 
  sep = ";", 
  na.strings = c(""," "))

asset_products_raw
```

```{r}
skimr::skim(asset_products_raw)
```

`ACCOUNT_NUMBER` is the unique customer identifier.

```{r}
asset_products_raw %>% 
  filter(!is.na(NATIONAL_ID)) %>% 
  count(CUSTOMER_NUMBER, sort = TRUE)

asset_products_raw %>% 
  filter(!is.na(NATIONAL_ID)) %>% 
  count(ACCOUNT_NUMBER, sort = TRUE)

asset_products_raw %>% 
  filter(ACCOUNT_NUMBER=="100141")

asset_products_raw %>% 
  filter(!is.na(NATIONAL_ID)) %>% 
  distinct(ACCOUNT_NUMBER,PRODUCT) %>% 
  filter(ACCOUNT_NUMBER=="100141")
```

## Product holding

The table below returns a table showing products held by each account (1 product, 1 account). n should be 1 in all cases.

```{r}
asset_product_holding <-
asset_products_raw %>% 
  distinct(ACCOUNT_NUMBER,PRODUCT) %>% 
  mutate(PRODUCT = str_remove(string = PRODUCT, pattern = "^Dom - ")) %>% 
  add_count(ACCOUNT_NUMBER, PRODUCT) %>% 
  filter(ACCOUNT_NUMBER >= 100000) %>% 
  mutate(ACCOUNT_NUMBER = as.character(ACCOUNT_NUMBER))

asset_product_holding
```


## Sense check

Check that a product is mapped once per customer (account number) and no NAs.

```{r}
asset_product_holding %>% distinct(PRODUCT)
```


```{r}
asset_product_holding %>% 
  arrange(desc(n))
```

Check that there are customers that hold more than one product.

```{r}
asset_product_holding %>% 
  count(ACCOUNT_NUMBER, sort = TRUE)
```

Check the number and names of products.

```{r}
asset_product_holding %>% 
  count(PRODUCT)
```

# LIFE INSURANCE

## Data exploration

Life insurance products

```{r}
life_products_raw <- 
read.csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_life_insurance.oipa.csv",
         sep = ";",
         na.strings = c(""," ")) %>% 
  filter(str_length(CUSTOMER_NUMBER) > 0) %>%
  filter(!is.na(CUSTOMER_NUMBER))

life_products_raw
```


```{r}
life_products_raw %>% 
  count(CUSTOMER_NUMBER, sort = TRUE)
```

`CUSTOMER_NUMBER` is the unique customer identifier.

```{r}
life_products_raw %>% 
  filter(CUSTOMER_NUMBER=="197AF68C-4A0C-4513-BF7B-E177C522FF26")
```

## Product holding

```{r}
life_product_holding <-
life_products_raw %>% 
  distinct(CUSTOMER_NUMBER, PRODUCT) %>% 
  add_count(CUSTOMER_NUMBER, PRODUCT)

life_product_holding
```
## Sense check

Check NAs

```{r}
life_product_holding %>% distinct(PRODUCT)

life_product_holding %>% filter(str_detect(CUSTOMER_NUMBER,"NA"))
```


Check each product is mapped once per customer.

```{r}
unique(life_product_holding$n)
```
Check that a customer can have many products under them.

```{r}
life_product_holding %>% 
  count(CUSTOMER_NUMBER, sort = TRUE)
```

Number of products

```{r}
life_product_holding %>% 
  count(PRODUCT)
```

# GENERAL INSURANCE

## Data exploration

`CUSTOMER_NO` is the customer identifier.

```{r}
gi_products_raw <-
read.csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_general_insurance.csv") %>% 
  distinct(CUSTOMER_NO, POLICY_TYPE_CODE)

gi_products_raw
```

Load product names and products currently not discontinued shared separately by Farai on his One Drive.

```{r}
gi_prod_names <-
read_excel(
  path = "../../../../../../C - Documentation/Data/festus_extraction/ZW/supp_product_details.xlsx", sheet = "GI") %>% 
  filter(STATUS == "Keep")
  
gi_prod_names
```

## Product holding

```{r}
gi_product_holding <-
gi_products_raw %>% 
  left_join(gi_prod_names, by = c("POLICY_TYPE_CODE"="PROD-TYPE")) %>% 
  filter(!is.na(DESCRIPTION)) %>% 
  count(CUSTOMER_NO,DESCRIPTION)

gi_product_holding
```

## Sense check

Check for NA values.

```{r}
gi_product_holding %>% 
  filter(is.na(DESCRIPTION))
```


# LENDING

## Data exploration

`account_no` is the customer identifier.

```{r}
read.csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_lending.csv") %>% 
  distinct(account_no,loan_account_no) %>% 
  count(account_no)
```

## Product holding

```{r}
lending_product_holding_raw <-
read.csv(file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_lending.csv", 
         na.strings = c(""," ")) %>% 
  distinct(account_no,product) %>% 
  count(account_no,product) %>% 
  filter(!is.na(product))

lending_product_holding_raw
```

## Fix lending product names

```{r}
lending_full_names <-
readxl::read_excel(
  path = "../../../../../../C - Documentation/Data/festus_extraction/ZW/supp_product_details.xlsx",
  sheet = "Lending") %>% 
  janitor::clean_names()

lending_full_names
```


```{r}
lending_product_holding <-
lending_product_holding_raw %>% 
  left_join(lending_full_names, by = c("product"="abbreviation")) %>% 
  mutate(product = coalesce(full_name,product)) %>% 
  select(-full_name)

lending_product_holding
```

## Sense check

Check for NA values.

```{r}
lending_product_holding %>% 
  distinct(product)
```

# BANKING

## T24

### Data exploration

T24

`CUSTOMER_NUMBER` is the unique customer identifier.

```{r}
read.csv(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_t24_banking.csv",
  sep = ";") %>%
  filter(CUSTOMER_NUMBER=="5128655")
```
 
### Product holding

```{r}
t24_product_holding <-
fread(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_t24_banking.csv",
  sep = ";") %>% 
  distinct(CUSTOMER_NUMBER, PRODUCT) %>% 
  count(CUSTOMER_NUMBER, PRODUCT)

t24_product_holding
```

## Postilion 

### Data exploration

`CUSTOMER_NUMBER` is the unique customer identifier. Product column requires filtering of invalid product numbers.

```{r}
fread(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_postilion_banking.csv", 
  sep = ";") %>% 
  filter(str_detect(string = PRODUCT, pattern = "[[:alpha:]]")) %>% 
  count(CUSTOMER_NUMBER, sort = TRUE)
```

### Product holding

```{r}
postilion_product_holding <-
fread(
  file = "../../../../../../C - Documentation/Data/festus_extraction/ZW/customer_postilion_banking.csv", 
  sep = ";", na.strings = c(""," ")) %>% 
  filter(!is.na(CUSTOMER_NUMBER)) %>% 
  filter(str_detect(string = PRODUCT, pattern = "[[:alpha:]]")) %>% 
  distinct(CUSTOMER_NUMBER, PRODUCT) %>% 
  count(CUSTOMER_NUMBER, PRODUCT)

postilion_product_holding
```

## Banking product holding

```{r}
banking_product_holding <- 
  rbind(t24_product_holding, 
        postilion_product_holding) %>% 
  distinct(CUSTOMER_NUMBER, PRODUCT, .keep_all = TRUE)

banking_product_holding
```

## Sense check

Banking has too many products including irrelevant ones.

```{r}
banking_product_holding %>% 
  distinct(PRODUCT) %>% 
  write_csv("../outputs/banking_products.csv")
```



# EXPORT

```{r}
#dir.create("../outputs/objects", recursive = TRUE)
save.image(file = "../outputs/images/27May.RData")
#load(file = "../outputs/images/24May.RData")

saveRDS(object = asset_product_holding, 
        file = "../outputs/objects/asset_product_holding.rds")
saveRDS(object = life_product_holding, 
        file = "../outputs/objects/life_product_holding.rds")
saveRDS(object = gi_product_holding,
        file = "../outputs/objects/gi_product_holding.rds")
saveRDS(object = lending_product_holding,
        file = "../outputs/objects/lending_product_holding.rds")
saveRDS(object = banking_product_holding,
        file = "../outputs/objects/banking_product_holding.rds")
```









